CREATE TABLE DEPT
(
	DEPTNO CHAR(1) PRIMARY KEY,
	DNAME VARCHAR(25) NOT NULL,
	MANAGER CHAR(4),
	EX1 FLOAT,
	EX2 VARCHAR(25)   
);

INSERT INTO DEPT (DEPTNO, DNAME, MANAGER)VALUES
('F','FINANCE','F001'),
('R','R & D','R001'),
('P','PRODUCTION','P001'),
('S','SALES','S001');

CREATE TABLE EMP
(
	ENUM CHAR(4) PRIMARY KEY,
    BASIC_SAL FLOAT NOT NULL,
    DEPTNO CHAR(1) NOT NULL,
    JOB CHAR(1) DEFAULT 'W' NOT NULL
    CONSTRAINT CH_EMP_JOB CHECK (JOB IN ('M', 'S', 'W')),
    HOLIDAYS TINYINT DEFAULT 0,
    CITY VARCHAR(4),
    HRA FLOAT,
    TOTSAL FLOAT,
    HIREDATE DATE NOT NULL,
    EX1 FLOAT,
    EX2 INT,
    EX3 VARCHAR(25),
    CONSTRAINT FK_DEPT_EMP FOREIGN KEY (DEPTNO)
    REFERENCES DEPT (DEPTNO)
);

DELIMITER //
CREATE TRIGGER AI_EMP
AFTER INSERT
ON EMP FOR EACH ROW
BEGIN
	DECLARE COMM FLOAT;
    DECLARE EXP INT;
    DECLARE HRA FLOAT;
	IF (POSITION('S' IN NEW.ENUM)=1) AND NEW.JOB='W' THEN
		SET EXP=DATEDIFF(SYSDATE(), NEW.HIREDATE);
		IF (EXP>10*365) THEN
			SET COMM = 0.05;
		ELSEIF (EXP>5*365) THEN
			SET COMM=0.04;
		ELSE
			SET COMM=0.03;
        END IF;
        INSERT INTO SALESMAN VALUES (NEW.ENUM, COMM, NEW.CITY);
    END IF;
    INSERT INTO EMP_AUDIT VALUES (NULL, NEW.ENUM, USER(), SYSDATE(), CONCAT(ENUM, ' EMPLOYEE ADDED SUCESSFULLY'));
END; //
DELIMITER ;

CREATE TABLE EMP_DETAILS
(
	ENUM CHAR(4) PRIMARY KEY,
    ENAME VARCHAR(25) NOT NULL,
    MOB BIGINT NOT NULL
    CONSTRAINT CH_EMP_MOB CHECK (LENGTH(MOB)=10),
    GEN CHAR(1) NOT NULL
    CONSTRAINT CH_EMP_GEN CHECK (GEN IN('M', 'F', 'T')),
    AADHAR BIGINT NOT NULL
    CONSTRAINT CH_EMP_AADHAR CHECK (LENGTH(AADHAR)=12),
    DOB DATE NOT NULL,
    CITY VARCHAR(4) NOT NULL,
    PINCODE INT NOT NULL
    CONSTRAINT CH_EMP_PINCODE CHECK (LENGTH(PINCODE)=6),
    ADDRESS TEXT,
    EX1 FLOAT,
    EX2 INT,
    EX3 VARCHAR(25),
    UNIQUE (AADHAR),
    UNIQUE (MOB),
    CONSTRAINT FK_EMP_EMP_DETAILS FOREIGN KEY(ENUM)
    REFERENCES EMP (ENUM) ON DELETE CASCADE
);

DELIMITER //
CREATE TRIGGER AI_EMP_DETAILS
AFTER INSERT
ON EMP_DETAILS FOR EACH ROW
BEGIN
    DECLARE H FLOAT;
    DECLARE TOT FLOAT;
    IF (NEW.CITY IN('BOMB','PUNE', 'DELH', 'CHEN')) THEN 
		SET H=0.5;
	ELSE
		SET H=0.4;
    END IF;
    SET TOT= TOTSALCAL(NEW.ENUM, H);
    UPDATE EMP SET HRA=H, EMP.CITY=NEW.CITY, EMP.TOTSAL=TOT WHERE EMP.ENUM=NEW.ENUM;
    INSERT INTO EMP_AUDIT VALUES (NULL, NEW.ENUM, USER(), SYSDATE(), CONCAT(ENUM,' HRA=',H,' AND DETAILS ADDED SUCESSFULLY'));
END; //
DELIMITER ;

CREATE TABLE SALESMAN
(
	SNUM CHAR(4) PRIMARY KEY,
    COMM FLOAT,
    LOC VARCHAR(4) NOT NULL,
    CONSTRAINT FK_EMP_SALESMAN FOREIGN KEY (SNUM)
    REFERENCES EMP (ENUM)
);

CREATE TABLE EMP_AUDIT
(
	SR_NO INT PRIMARY KEY AUTO_INCREMENT,
    ENUM CHAR(4),
    USER VARCHAR(25),
    TIME_STAMP DATETIME,
    REMARK VARCHAR(200)
);

DELIMITER //
CREATE FUNCTION TOTSALCAL(EMPNO CHAR(4), H FLOAT)
RETURNS FLOAT
DETERMINISTIC
BEGIN
	DECLARE SALARY FLOAT;
    DECLARE SALPDAY FLOAT;
    DECLARE HOLI TINYINT;
    DECLARE COM FLOAT;
    DECLARE TOT FLOAT;
    SELECT BASIC_SAL, HOLIDAYS INTO SALARY, HOLI FROM EMP
    WHERE ENUM=EMPNO;
    SET SALPDAY=SALARY/30;
	SET TOT=SALARY-(SALPDAY*HOLI)+(H*SALARY);
    RETURN TOT;
END; //
DELIMITER ;

INSERT INTO EMP (ENUM, BASIC_SAL, DEPTNO, JOB, CITY, HIREDATE) VALUES
('F001', 34000, 'F', 'M', 'BOMB', '1988-09-21'),
('F002', 30000, 'F', 'S', 'BOMB', '1991-08-25'),
('F003', 25000, 'F', 'W', 'BOMB', '1998-09-21'),
('F004', 22000, 'F', 'W', 'BOMB', '2004-11-1'),
('R001', 34000, 'R', 'M', 'BOMB', '1999-12-11'),
('R002', 31000, 'R', 'S', 'BOMB', '2006-7-27'),
('R003', 25000, 'R', 'W', 'PUNE', '2010-4-1'),
('R004', 21000, 'R', 'W', 'BOMB', '2015-05-19'),
('P001', 32000, 'P', 'M', 'BOMB', '1992-05-19'),
('P002', 23000, 'P', 'S', 'BOMB', '1997-04-18'),
('P003', 20000, 'P', 'W', 'BOMB', '2004-03-29'),
('P004', 19000, 'P', 'W', 'BOMB', '2010-09-8'),
('P005', 18000, 'P', 'W', 'BOMB', '2015-09-21'),
('S001', 34000, 'S', 'M', 'BOMB', '1990-09-20'),
('S002', 21000, 'S', 'W', 'BOMB', '2010-08-10'),
('S003', 20000, 'S', 'W', 'PUNE', '2012-1-11'),
('S004', 20000, 'S', 'W', 'NAGP', '2016-09-13'),
('S005', 19000, 'S', 'W', 'DELH', '2017-02-15'),
('S006', 18500, 'S', 'W', 'CHEN', '2018-7-23'),
('S007', 17000, 'S', 'W', 'BEED', '2019-5-2');

INSERT INTO EMP_DETAILS (ENUM, ENAME, MOB, GEN, AADHAR, DOB, CITY, PINCODE, ADDRESS) VALUES
('F001', 'ABHISHEK KUMAR BHAGAUS', 9986995765,'M', 123456788765, '1971-07-23', 'BOMB', 400622, '29/SHWETAMBARI APT, BHATWADI, THANE'),
('F002', 'HRISHIK SUDHIR SHETTY', 9869989658,'M', 113456788765, '1975-01-30', 'BOMB', 400612, '12/SAI SADAN, KISSAN NAGAR, BHATWADI, THANE'),
('F003', 'MASIRA SHAIKH', 9989995765,'F', 552356788765, '1980-12-3', 'BOMB', 401620, 'B-64/KRANTI TOWERS, NARIMAN POINT, MUMBAI'),
('F004', 'SANDEEP RAMPRAKASH SAHU', 8069995765,'M', 623456778769, '1984-07-23', 'BOMB', 400611, NULL),
('R001', 'SHRIRAM RAMADEVI IYER', 8890095765,'M', 671459978769, '1973-08-13', 'BOMB', 400641, 'Ground Floor 56 Nagdevi St Mandvi, Mumbai'),
('R002', 'VIJAYALAKSHMI IYER', 8891695700,'F', 771454978669, '1981-08-11', 'BOMB', 401641, '234  S.v.road Opp. Railway Station Andheri, Mumbai'),
('R003', 'PALLAVI BAKALE', 8199987657,'F', 451453478721, '1987-09-2', 'PUNE', 400600, '49  Wafa Chs Laxmibe Cheda Marg Nalasopara, Pune'),
('R004', 'SAIRAJ VINAYAK HEGISHTE', 9099095765,'M', 311359998759, '1988-01-11', 'BOMB', 400631, 'Mittal Chambers Yogakshema , Mumbai'),
('P001', 'VASNAT NADAR', 9833095765,'M', 119889998759, '1966-01-17', 'BOMB', 403631, 'D-302 Ttc Indl Area Turbhe Naka Turbhe, Mumbai'),
('P002', 'NADAR BALAJI SHAKTIVEL', 9837895765,'M', 341259998009, '1975-01-31', 'BOMB', 400630, 'W-258257256 Midc Phase Ii Shivaji Udyog Nagar Dombivli, Mumbai'),
('P003', 'ROHAN JANARDAN CHAVAN', 8003095700,'M', 711259998899, '1986-09-19', 'BOMB', 400689, 'Jabbar Complex Begumpet, Hyderabad,Mumbai'),
('P004', 'SINGH ADITYA SUGREEV', 9038995787,'M', 321259998567, '1988-07-1', 'BOMB', 401006, '28  Western Highway Sativali Vasai , Mumbai'),
('P005', 'SUMEET SURESH PILLAI', 8102395787,'M', 561259788346, '1994-01-12', 'BOMB', 400026, '104  Sarang Street Near Crawford Market Mandvi'),
('S001', 'SOHAM BALAKRISHNAN K', 8882395788,'M', 781259788721, '1994-01-12', 'BOMB', 402026, '2/3 Shri Gurudutta Krupa Chs R B Mehta Road Patel Chowk Near Rly Station, THANE'),
('S002', 'SOHAN VISHNU GOWDA', 9702394487,'M', 568759783456, '1994-01-12', 'BOMB', 401121, '424  Plot No  Persipolis Prem Sec  Vashi Navi Mumba'),
('S003', 'RITESH MAHESH SHIKNE', 7920211781,'M', 432259788711, '1994-01-12', 'PUNE', 401025, '42 -b-c Mahavir Bldg Navneet Showroom Bhandark Matunga,,PUNE'),
('S004', 'MARTINRAJ JOHNRAJ NADAR', 8202300001,'M', 761259788123, '1994-01-12', 'NAGP', 401111, NULL),
('S005', 'KALPESH JOTIBA PATIL', 8802225722,'M', 566549788541, '1994-01-12', 'DELH', 401012, '40   Khetwadi Main Road Dr Bhajekar Street Behind Harkisandas Hospital Khetwadi, DELHI'),
('S006', 'JABIN JAGADEESAN NADAR', 7602393181,'M', 331259788776, '1994-01-12', 'CHEN', 401113, '156  Opp Remson Co Ganesh Nagar Charkop Kandivli, CHENNAI'),
('S007', 'CHAITANYA ABHAY GHATKAR', 7502395745,'M', 560259788709, '1994-01-12', 'BEED', 401020, NULL);